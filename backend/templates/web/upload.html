{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Bulk Upload & Analyze{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/upload.css' %}">

<!-- fixed message stack so alerts don't push the layout -->

<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card shadow-sm page-card">
        <div class="card-body d-flex flex-column">

          <header class="mb-3 d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div>
              <h1 class="h4 mb-1 mb-sm-0">Bulk upload</h1>
              <p class="text-muted mb-0 small">Choose multiple audio/video files. We'll process each in the background.</p>
            </div>

            <!-- small dark-mode toggle -->
            <button id="theme-toggle"
                    type="button"
                    class="btn btn-sm btn-outline-secondary align-self-start"
                    title="Toggle dark mode">
              <span data-light>üåô</span>
              <span data-dark style="display:none;">‚òÄÔ∏è</span>
            </button>
          </header>



          <form id="bulk-form" class="mb-3" enctype="multipart/form-data" novalidate>
            <div class="d-flex gap-2">
              <input class="form-control" type="file" id="files" name="files" accept="audio/*,video/*" multiple required>
              <button class="btn btn-outline-secondary" type="button" id="clear-files">Clear</button>
            </div>

            <div class="mt-3 d-flex align-items-center gap-3 flex-wrap">
              <button class="btn btn-warning" type="button" id="enqueue-btn">
                <span class="btn-label">Analyze selected</span>
                <span class="spinner-border spinner-border-sm d-none ms-2" role="status" aria-hidden="true" id="btn-spinner"></span>
              </button>

              <a class="link-secondary" href="{% url 'reset_session' %}">Reset session</a>

              <div class="vr d-none d-sm-block"></div>

              <!-- Right-aligned bulk JSON actions -->
              <div class="ms-auto d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" type="button" id="copy-all-json">
                  <span class="btn-label">Copy all JSON</span>
                  <span class="spinner-border spinner-border-sm d-none ms-2" role="status" aria-hidden="true"></span>
                </button>
                <button class="btn btn-sm btn-outline-secondary" type="button" id="export-all-json">
                  <span class="btn-label">Export all JSON</span>
                  <span class="spinner-border spinner-border-sm d-none ms-2" role="status" aria-hidden="true"></span>
                </button>
              </div>

            </div>
          </form>

          <div id="error" class="alert alert-danger d-none" role="alert"></div>

          <!-- scrollable table area -->
          <div class="table-shell">
            <div class="table-responsive table-scroll">
              <table class="table align-middle mb-0" id="jobs-table">
                <colgroup>
                  <col style="width: 40%;">
                  <col style="width: 12%;">
                  <col style="width: 10%;">
                  <col style="width: 38%;">
                </colgroup>

                <thead class="table-head">
                  <tr>
                    <th>File</th>
                    <th>Size</th>
                    <th>Status</th>
                    <th class="text-end">Action</th>
                  </tr>
                </thead>
                <tbody id="jobs-body"></tbody>
              </table>
            </div>
          </div>

          <div id="toast-area" class="toast-area"></div>
        </div>
      </div>
    </div>
  </div>
</div>

{# === Job Detail Modal (Bootstrap 5) === #}
<div class="modal fade" id="jobDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Job details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div id="job-modal-body">
          <div class="text-muted">Loading‚Ä¶</div>
        </div>
      </div>

      <div class="modal-footer">
        <a id="job-modal-open-page" class="btn btn-outline-primary d-none" target="_blank" rel="noopener">Open full page</a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
{% load static %}

<script src="{% static 'js/ub/ub_dom.js' %}"></script>
<script src="{% static 'js/ub/ub_cache.js' %}"></script>  {# <-- add this #}
<script src="{% static 'js/ub/ub_api.js' %}"></script>
<script src="{% static 'js/ub/ub_modal.js' %}"></script>
<script src="{% static 'js/ub/ub_table.js' %}"></script>
<script src="{% static 'js/ub/ub_bulk.js' %}"></script>
<script src="{% static 'js/upload_bulk.main.js' %}"></script>
<script src="{% static 'js/theme.js' %}"></script>

{% endblock %}
